#!/usr/bin/env python3

from http.server import HTTPServer, SimpleHTTPRequestHandler, test as test_orig
import sys
def test (*args):
    test_orig(*args, port=int(sys.argv[1]) if len(sys.argv) > 1 else 8000)

class CORSRequestHandler (SimpleHTTPRequestHandler):
    def end_headers (self):
        self.send_header('Access-Control-Allow-Origin', '*')
        self.send_header('Cache-Control', 'no-cache, no-store, must-revalidate')
        self.send_header('Pragma', 'no-cache')
        self.send_header('Expires', '0')
        SimpleHTTPRequestHandler.end_headers(self)

    def do_POST(self):
        print(">>> " + self.headers['Message'])
        self.send_response(200)
        self.end_headers()

    def log_request(self, code='-', size='-'):
        if self.path != '/do_network_log':
            super().log_request(code, size)

if __name__ == '__main__':
    server = HTTPServer
    server.request_queue_size = 128
    test(CORSRequestHandler, HTTPServer)
